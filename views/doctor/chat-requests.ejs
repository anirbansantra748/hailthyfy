<%- include('../partials/header') %>

<div class="container mt-5">
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="text-primary">Chat Requests</h2>
      <p class="text-muted">Manage patient chat requests</p>
    </div>
  </div>

  <% if (!chatRequests || validChatRequests.length === 0) { %>
  <div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i> You don't have any chat requests at the moment.
  </div>
  <% } else { %>
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <ul class="nav nav-tabs card-header-tabs" id="requestTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending"
                type="button" role="tab" aria-controls="pending" aria-selected="true">
                Pending
                <span class="badge bg-primary rounded-pill ms-1" id="pendingCount"></span>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="accepted-tab" data-bs-toggle="tab" data-bs-target="#accepted"
                type="button" role="tab" aria-controls="accepted" aria-selected="false">
                Accepted
                <span class="badge bg-success rounded-pill ms-1" id="acceptedCount"></span>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected"
                type="button" role="tab" aria-controls="rejected" aria-selected="false">
                Rejected
                <span class="badge bg-danger rounded-pill ms-1" id="rejectedCount"></span>
              </button>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content" id="requestTabsContent">
            <!-- Pending Requests Tab -->
            <div class="tab-pane fade show active" id="pending" role="tabpanel" aria-labelledby="pending-tab">
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Patient</th>
                      <th>Request Date</th>
                      <th>Consultation Type</th>
                      <th>Urgency</th>
                      <th>Reason</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% validChatRequests.filter(req => req.status === 'pending').forEach(function(request) { %>
                    <% if (request && request.user) { %>
                    <tr>
                      <td>
                        <div class="d-flex align-items-center">
                          <% if (request.user && request.user.profileImage) { %>
                          <img src="<%= request.user.profileImage %>" alt="<%= request.user.name %>"
                            class="rounded-circle me-2" width="40" height="40" />
                          <% } else { %>
                          <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2"
                            style="width: 40px; height: 40px">
                            <%= request.user.name.charAt(0).toUpperCase() %>
                          </div>
                          <% } %>
                          <div>
                            <h6 class="mb-0"><%= request.user.name %></h6>
                            <small class="text-muted"><%= request.user.email %></small>
                          </div>
                        </div>
                      </td>
                      <td>
                        <%= new Date(request.createdAt).toLocaleDateString() %>
                      </td>
                      <td>
                        <span class="badge bg-info text-dark"><%= request.consultationType %></span>
                      </td>
                      <td>
                        <% if (request.urgency === 'high') { %>
                        <span class="badge bg-danger">High</span>
                        <% } else if (request.urgency === 'medium') { %>
                        <span class="badge bg-warning text-dark">Medium</span>
                        <% } else { %>
                        <span class="badge bg-success">Low</span>
                        <% } %>
                      </td>
                      <td>
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal"
                          data-bs-target="#requestDetailsModal<%= request._id %>">
                          View Details
                        </button>
                      </td>
                      <td>
                        <div class="btn-group" role="group">
                          <button type="button" class="btn btn-success btn-sm"
                            onclick="acceptRequest('<%= request._id %>')">
                            <i class="fas fa-check me-1"></i> Accept
                          </button>
                          <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal"
                            data-bs-target="#rejectModal<%= request._id %>">
                            <i class="fas fa-times me-1"></i> Reject
                          </button>
                        </div>
                      </td>
                    </tr>

                    <!-- Request Details Modal -->
                    <div class="modal fade" id="requestDetailsModal<%= request._id %>" tabindex="-1"
                      aria-labelledby="requestDetailsModalLabel<%= request._id %>" aria-hidden="true">
                      <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="requestDetailsModalLabel<%= request._id %>">
                              Request Details
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <div class="row">
                              <div class="col-md-6">
                                <h6>Patient Information</h6>
                                <p><strong>Name:</strong> <%= request.user.name %></p>
                                <p><strong>Email:</strong> <%= request.user.email %></p>
                              </div>
                              <div class="col-md-6">
                                <h6>Request Information</h6>
                                <p><strong>Date:</strong> <%= new Date(request.createdAt).toLocaleString() %></p>
                                <p><strong>Consultation Type:</strong> <%= request.consultationType %></p>
                                <p><strong>Urgency:</strong> <%= request.urgency %></p>
                              </div>
                            </div>
                            <hr />
                            <h6>Reason for Consultation</h6>
                            <p><%= request.reason %></p>

                            <% if (request.symptoms && request.symptoms.length > 0) { %>
                            <h6>Symptoms</h6>
                            <ul>
                              <% request.symptoms.forEach(function(symptom) { %>
                              <li><%= symptom %></li>
                              <% }); %>
                            </ul>
                            <% } %>
                            
                            <% if (request.currentMedications && request.currentMedications.length > 0) { %>
                            <h6>Current Medications</h6>
                            <ul>
                              <% request.currentMedications.forEach(function(medication) { %>
                              <li><%= medication %></li>
                              <% }); %>
                            </ul>
                            <% } %>
                            
                            <% if (request.allergies && request.allergies.length > 0) { %>
                            <h6>Allergies</h6>
                            <ul>
                              <% request.allergies.forEach(function(allergy) { %>
                              <li><%= allergy %></li>
                              <% }); %>
                            </ul>
                            <% } %>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Reject Modal -->
                    <div class="modal fade" id="rejectModal<%= request._id %>" tabindex="-1"
                      aria-labelledby="rejectModalLabel<%= request._id %>" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="rejectModalLabel<%= request._id %>">
                              Reject Chat Request
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <form id="rejectForm<%= request._id %>">
                              <div class="mb-3">
                                <label for="rejectionReason<%= request._id %>" class="form-label">Reason for Rejection (Optional)</label>
                                <textarea class="form-control" id="rejectionReason<%= request._id %>" rows="3"
                                  placeholder="Provide a reason for rejecting this chat request"></textarea>
                              </div>
                            </form>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger" onclick="rejectRequest('<%= request._id %>')">
                              <i class="fas fa-times me-1"></i> Reject Request
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <% } %>
                    <% }); %>
                    
                    <% if (chatRequests.filter(req => req.status === 'pending').length === 0) { %>
                    <tr>
                      <td colspan="6" class="text-center py-4">
                        <p class="text-muted mb-0">No pending chat requests</p>
                      </td>
                    </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Accepted Requests Tab -->
            <div class="tab-pane fade" id="accepted" role="tabpanel" aria-labelledby="accepted-tab">
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Patient</th>
                      <th>Request Date</th>
                      <th>Accepted Date</th>
                      <th>Consultation Type</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% chatRequests.filter(req => req.status === 'accepted').forEach(function(request) { %>
                    <tr>
                      <td>
                        <div class="d-flex align-items-center">
                          <% if (request.user.profileImage) { %>
                          <img src="<%= request.user.profileImage %>" alt="<%= request.user.name %>"
                            class="rounded-circle me-2" width="40" height="40" />
                          <% } else { %>
                          <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2"
                            style="width: 40px; height: 40px">
                            <%= request.user.name.charAt(0).toUpperCase() %>
                          </div>
                          <% } %>
                          <div>
                            <h6 class="mb-0"><%= request.user.name %></h6>
                            <small class="text-muted"><%= request.user.email %></small>
                          </div>
                        </div>
                      </td>
                      <td><%= new Date(request.createdAt).toLocaleDateString() %></td>
                      <td><%= new Date(request.acceptedAt).toLocaleDateString() %></td>
                      <td>
                        <span class="badge bg-info text-dark"><%= request.consultationType %></span>
                      </td>
                      <td>
                        <a href="/chat/<%= request.chatId %>" class="btn btn-primary btn-sm">
                          <i class="fas fa-comments me-1"></i> Open Chat
                        </a>
                      </td>
                    </tr>
                    <% }); %>
                    
                    <% if (chatRequests.filter(req => req.status === 'accepted').length === 0) { %>
                    <tr>
                      <td colspan="5" class="text-center py-4">
                        <p class="text-muted mb-0">No accepted chat requests</p>
                      </td>
                    </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Rejected Requests Tab -->
            <div class="tab-pane fade" id="rejected" role="tabpanel" aria-labelledby="rejected-tab">
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Patient</th>
                      <th>Request Date</th>
                      <th>Rejected Date</th>
                      <th>Consultation Type</th>
                      <th>Rejection Reason</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% chatRequests.filter(req => req.status === 'rejected').forEach(function(request) { %>
                    <tr>
                      <td>
                        <div class="d-flex align-items-center">
                          <% if (request.user.profileImage) { %>
                          <img src="<%= request.user.profileImage %>" alt="<%= request.user.name %>"
                            class="rounded-circle me-2" width="40" height="40" />
                          <% } else { %>
                          <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2"
                            style="width: 40px; height: 40px">
                            <%= request.user.name.charAt(0).toUpperCase() %>
                          </div>
                          <% } %>
                          <div>
                            <h6 class="mb-0"><%= request.user.name %></h6>
                            <small class="text-muted"><%= request.user.email %></small>
                          </div>
                        </div>
                      </td>
                      <td><%= new Date(request.createdAt).toLocaleDateString() %></td>
                      <td><%= new Date(request.rejectedAt).toLocaleDateString() %></td>
                      <td>
                        <span class="badge bg-info text-dark"><%= request.consultationType %></span>
                      </td>
                      <td>
                        <% if (request.rejectedReason) { %>
                        <%= request.rejectedReason %>
                        <% } else { %>
                        <span class="text-muted">No reason provided</span>
                        <% } %>
                      </td>
                    </tr>
                    <% }); %>
                    
                    <% if (chatRequests.filter(req => req.status === 'rejected').length === 0) { %>
                    <tr>
                      <td colspan="5" class="text-center py-4">
                        <p class="text-muted mb-0">No rejected chat requests</p>
                      </td>
                    </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <% } %>
</div>

<script>
  // Update tab counts
  document.addEventListener("DOMContentLoaded", function () {
    const pendingCount = document.getElementById("pendingCount");
    const acceptedCount = document.getElementById("acceptedCount");
    const rejectedCount = document.getElementById("rejectedCount");

    const pendingRequests = JSON.parse(
      "<%= JSON.stringify(chatRequests.filter(req => req.status === 'pending').length) %>"
    );
    const acceptedRequests = JSON.parse(
      "<%= JSON.stringify(chatRequests.filter(req => req.status === 'accepted').length) %>"
    );
    const rejectedRequests = JSON.parse(
      "<%= JSON.stringify(chatRequests.filter(req => req.status === 'rejected').length) %>"
    );

    pendingCount.textContent = pendingRequests;
    acceptedCount.textContent = acceptedRequests;
    rejectedCount.textContent = rejectedRequests;
  });

  // Accept chat request
  function acceptRequest(requestId) {
    if (!confirm("Are you sure you want to accept this chat request?")) {
      return;
    }

    fetch(`/chat/request/${requestId}/accept`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        notes: "",
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert("Chat request accepted successfully!");
          window.location.href = `/chat/${data.chatId}`;
        } else {
          alert(`Error: ${data.message}`);
        }
      })
      .catch((error) => {
        console.error("Error accepting chat request:", error);
        alert("Failed to accept chat request. Please try again.");
      });
  }

  // Reject chat request
  function rejectRequest(requestId) {
    const reason = document.getElementById(`rejectionReason${requestId}`).value;

    fetch(`/chat/request/${requestId}/reject`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        reason: reason,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert("Chat request rejected successfully!");
          window.location.reload();
        } else {
          alert(`Error: ${data.message}`);
        }
      })
      .catch((error) => {
        console.error("Error rejecting chat request:", error);
        alert("Failed to reject chat request. Please try again.");
      });
  }
</script>

<%- include('../partials/footer') %>
