<% layout('/layouts/boilerplate') %>

<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h3>Edit Post</h3>
        </div>
        <div class="card-body">
          <form action="/posts/<%= post._id %>?_method=PUT" method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
            <div class="mb-3">
              <label for="title" class="form-label">Title</label>
              <input type="text" class="form-control" id="title" name="title" 
                     value="<%= post.title %>" required>
              <div class="invalid-feedback">
                Please provide a title.
              </div>
            </div>

            <div class="mb-3">
              <label for="content" class="form-label">Content</label>
              <textarea class="form-control" id="content" name="content" rows="8" required><%= post.content %></textarea>
              <div class="invalid-feedback">
                Please provide content for your post.
              </div>
            </div>

            <div class="mb-3">
              <label for="category" class="form-label">Category</label>
              <select class="form-select" id="category" name="category">
                <option value="general" <%= post.category === 'general' ? 'selected' : '' %>>General</option>
                <option value="health" <%= post.category === 'health' ? 'selected' : '' %>>Health</option>
                <option value="fitness" <%= post.category === 'fitness' ? 'selected' : '' %>>Fitness</option>
                <option value="nutrition" <%= post.category === 'nutrition' ? 'selected' : '' %>>Nutrition</option>
                <option value="disease" <%= post.category === 'disease' ? 'selected' : '' %>>Disease</option>
                <option value="mental_health" <%= post.category === 'mental_health' ? 'selected' : '' %>>Mental Health</option>
                <option value="medicine" <%= post.category === 'medicine' ? 'selected' : '' %>>Medicine</option>
                <option value="announcement" <%= post.category === 'announcement' ? 'selected' : '' %>>Announcement</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="tags" class="form-label">Tags (comma-separated)</label>
              <input type="text" class="form-control" id="tags" name="tags" 
                     value="<%= post.tags.join(', ') %>" 
                     placeholder="health, fitness, nutrition">
              <div class="form-text">Enter tags separated by commas</div>
            </div>

            <!-- Current Images -->
            <% if (post.images && post.images.length > 0) { %>
              <div class="mb-3">
                <label class="form-label">Current Images</label>
                <div class="row">
                  <% post.images.forEach((image, index) => { %>
                    <div class="col-md-4 mb-2">
                      <div class="position-relative">
                        <img src="<%= image %>" class="img-fluid rounded" alt="Post image">
                        <div class="form-check position-absolute top-0 end-0 m-2">
                          <input class="form-check-input" type="checkbox" name="removeImages" 
                                 value="<%= image %>" id="removeImage<%= index %>">
                          <label class="form-check-label text-white bg-dark px-1 rounded" 
                                 for="removeImage<%= index %>">
                            Remove
                          </label>
                        </div>
                      </div>
                    </div>
                  <% }) %>
                </div>
              </div>
            <% } %>

            <!-- Add New Images -->
            <div class="mb-3">
              <label for="images" class="form-label">Add New Images</label>
              <input type="file" class="form-control" id="images" name="images" 
                     multiple accept="image/*">
              <div class="form-text">You can select multiple images (max 6)</div>
            </div>

            <!-- Image Preview -->
            <div id="imagePreview" class="mb-3" style="display: none;">
              <label class="form-label">Image Preview</label>
              <div id="previewContainer" class="row"></div>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">Update Post</button>
              <a href="/posts/<%= post._id %>" class="btn btn-secondary">Cancel</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Image preview functionality
document.getElementById('images').addEventListener('change', function(e) {
  const files = e.target.files;
  const previewContainer = document.getElementById('previewContainer');
  const imagePreview = document.getElementById('imagePreview');
  
  previewContainer.innerHTML = '';
  
  if (files.length > 0) {
    imagePreview.style.display = 'block';
    
    Array.from(files).forEach((file, index) => {
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        const col = document.createElement('div');
        col.className = 'col-md-4 mb-2';
        
        reader.onload = function(e) {
          col.innerHTML = `
            <img src="${e.target.result}" class="img-fluid rounded" alt="Preview ${index + 1}">
          `;
        };
        
        reader.readAsDataURL(file);
        previewContainer.appendChild(col);
      }
    });
  } else {
    imagePreview.style.display = 'none';
  }
});

// Character counter for content
document.getElementById('content').addEventListener('input', function() {
  const maxLength = 5000;
  const currentLength = this.value.length;
  const remaining = maxLength - currentLength;
  
  if (!this.nextElementSibling || !this.nextElementSibling.classList.contains('form-text')) {
    const counter = document.createElement('div');
    counter.className = 'form-text';
    this.parentNode.appendChild(counter);
  }
  
  this.nextElementSibling.textContent = `${currentLength}/${maxLength} characters`;
  
  if (remaining < 100) {
    this.nextElementSibling.className = 'form-text text-warning';
  } else {
    this.nextElementSibling.className = 'form-text';
  }
});
</script>

