const { GoogleGenerativeAI } = require('@google/generative-ai');
require('dotenv').config();

// ЁЯдЦ REVOLUTIONARY AI HEALTH ASSISTANT SERVICE
class HealthAIService {
    constructor() {
        console.log('ЁЯдЦ [AI SERVICE] Initializing HealthAI Service...');
        
        // Check API key
        const apiKey = process.env.GEMINI_API_KEY;
        console.log('ЁЯФС [AI SERVICE] API Key status:', apiKey ? 
            (apiKey === 'demo-key' ? 'DEMO KEY (Invalid)' : `VALID (${apiKey.substring(0, 10)}...${apiKey.substring(apiKey.length-4)})`) : 
            'MISSING'
        );
        
        // Initialize Gemini AI (Free tier)
        this.genAI = new GoogleGenerativeAI(apiKey || 'demo-key');
        this.model = this.genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
        
        console.log('тЬЕ [AI SERVICE] Gemini AI initialized with model: gemini-1.5-flash');
        
        // Health-focused system prompts
        this.systemPrompts = {
            english: `You are HealthyAI, a friendly medical assistant. Be CONCISE and CLEAR.
            
            RESPONSE RULES:
            - Keep responses SHORT (2-4 sentences max)
            - Use SIMPLE language, no medical jargon
            - Be helpful but not overwhelming
            - Add one relevant emoji per response ЁЯШК
            - If serious symptoms: recommend seeing doctor immediately
            
            User Context: {userInfo}
            
            Respond briefly and helpfully.`,
            
            hindi: `рдЖрдк HealthyAI рд╣реИрдВ, рдПрдХ рдорд┐рддреНрд░рд╡рдд рдЪрд┐рдХрд┐рддреНрд╕рд╛ рд╕рд╣рд╛рдпрдХред рд╕рдВрдХреНрд╖рд┐рдкреНрдд рдФрд░ рд╕реНрдкрд╖реНрдЯ рд░рд╣реЗрдВред
            
            рдирд┐рдпрдо:
            - рдмрд╣реБрдд рдЫреЛрдЯреЗ рдЙрддреНрддрд░ рджреЗрдВ (2-4 рд╡рд╛рдХреНрдп)
            - рд╕рд░рд▓ рднрд╛рд╖рд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ
            - рд╕рд╣рд╛рдпрдХ рд▓реЗрдХрд┐рди рдмрд╣реБрдд рд╡рд┐рд╕реНрддреГрдд рдирд╣реАрдВ
            - рдЧрдВрднреАрд░ рд▓рдХреНрд╖рдгреЛрдВ рдХреЗ рд▓рд┐рдП: рдбреЙрдХреНрдЯрд░ рд╕реЗ рдорд┐рд▓рдиреЗ рдХреА рд╕рд▓рд╛рд╣ рджреЗрдВ
            
            рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рдВрджрд░реНрдн: {userInfo}
            
            рд╕рдВрдХреНрд╖рд┐рдкреНрдд рдФрд░ рд╕рд╣рд╛рдпрдХ рдЙрддреНрддрд░ рджреЗрдВред`
        };
    }

    /**
     * Detect language from user message
     */
    detectLanguage(message) {
        // Simple language detection
        const hindiPattern = /[\u0900-\u097F]/;
        return hindiPattern.test(message) ? 'hindi' : 'english';
    }

    /**
     * Create personalized system prompt with user info
     */
    createPersonalizedPrompt(userInfo, language = 'english') {
        const basePrompt = this.systemPrompts[language];
        const userContext = this.formatUserContext(userInfo, language);
        return basePrompt.replace('{userInfo}', userContext);
    }

    /**
     * Format user context for AI
     */
    formatUserContext(userInfo, language) {
        if (!userInfo) return 'No user information available';
        
        const info = [];
        
        if (userInfo.name) {
            info.push(language === 'hindi' ? 
                `рдирд╛рдо: ${userInfo.name}` : 
                `Name: ${userInfo.name}`
            );
        }
        
        if (userInfo.age) {
            info.push(language === 'hindi' ? 
                `рдЙрдореНрд░: ${userInfo.age} рд╕рд╛рд▓` : 
                `Age: ${userInfo.age} years`
            );
        }
        
        if (userInfo.gender) {
            info.push(language === 'hindi' ? 
                `рд▓рд┐рдВрдЧ: ${userInfo.gender}` : 
                `Gender: ${userInfo.gender}`
            );
        }
        
        if (userInfo.medicalHistory && userInfo.medicalHistory.length > 0) {
            info.push(language === 'hindi' ? 
                `рдЪрд┐рдХрд┐рддреНрд╕рд╛ рдЗрддрд┐рд╣рд╛рд╕: ${userInfo.medicalHistory.join(', ')}` : 
                `Medical History: ${userInfo.medicalHistory.join(', ')}`
            );
        }
        
        return info.join(', ') || (language === 'hindi' ? 
            'рдХреЛрдИ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЬрд╛рдирдХрд╛рд░реА рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ' : 
            'No user information available'
        );
    }

    /**
     * Generate AI health response (with image analysis support)
     */
    async generateHealthResponse(userMessage, userInfo = null, conversationHistory = [], imageData = null) {
        console.log('\nЁЯТм [AI SERVICE] ================== GENERATE RESPONSE ==================');
        console.log('ЁЯУЭ [AI SERVICE] Processing message:', userMessage);
        console.log('ЁЯСе [AI SERVICE] User info provided:', userInfo ? 'Yes' : 'No');
        console.log('ЁЯУЪ [AI SERVICE] Conversation history items:', conversationHistory.length);
        console.log('ЁЯЦ╝я╕П [AI SERVICE] Image data provided:', imageData ? `Yes (${imageData.length} images)` : 'No');
        
        try {
            // Detect language
            const language = this.detectLanguage(userMessage);
            console.log('ЁЯМН [AI SERVICE] Detected language:', language);
            
            // Create personalized prompt
            const systemPrompt = this.createPersonalizedPrompt(userInfo, language);
            console.log('ЁЯУЛ [AI SERVICE] System prompt created (length):', systemPrompt.length);
            
            // Build conversation context
            const conversationContext = this.buildConversationContext(
                conversationHistory, 
                userMessage, 
                systemPrompt, 
                language
            );
            console.log('ЁЯТм [AI SERVICE] Conversation context built (length):', conversationContext.length);
            console.log('ЁЯУЭ [AI SERVICE] Context preview:', conversationContext.substring(0, 200) + '...');
            
            console.log('ЁЯЪА [AI SERVICE] Sending request to Gemini AI...');
            
            let result, response, responseText;
            
            // Handle image analysis if images are provided
            if (imageData && imageData.length > 0) {
                console.log('ЁЯЦ╝я╕П [AI SERVICE] Processing with image analysis...');
                result = await this.analyzeImagesWithText(conversationContext, imageData, language);
                response = await result.response;
                responseText = response.text();
            } else {
                // Generate text-only response from Gemini
                result = await this.model.generateContent(conversationContext);
                console.log('ЁЯУб [AI SERVICE] Gemini AI responded successfully');
                
                response = await result.response;
                responseText = response.text();
            }
            
            console.log('ЁЯУЭ [AI SERVICE] Response text received (length):', responseText.length);
            console.log('ЁЯУЭ [AI SERVICE] Response preview:', responseText.substring(0, 150) + '...');
            
            // Add safety disclaimer for serious symptoms
            const disclaimedResponse = this.addSafetyDisclaimer(responseText, language);
            console.log('ЁЯЫбя╕П [AI SERVICE] Safety disclaimer checked and applied if needed');
            
            // Format response for better readability
            const finalResponse = this.formatResponse(disclaimedResponse, language);
            console.log('ЁЯОи [AI SERVICE] Response formatted for better readability');
            
            const successResponse = {
                success: true,
                response: finalResponse,
                language: language,
                timestamp: new Date(),
                model: 'gemini-1.5-flash'
            };
            
            console.log('тЬЕ [AI SERVICE] Response generated successfully');
            console.log('ЁЯПБ [AI SERVICE] ================== RESPONSE COMPLETE ==================\n');
            
            return successResponse;
            
        } catch (error) {
            console.error('\nЁЯТе [AI SERVICE] ================== ERROR OCCURRED ==================');
            console.error('тЭМ [AI SERVICE] Error type:', error.constructor.name);
            console.error('тЭМ [AI SERVICE] Error message:', error.message);
            
            if (error.message.includes('API_KEY_INVALID')) {
                console.error('ЁЯФС [AI SERVICE] ISSUE: Invalid or missing Gemini API key');
                console.error('ЁЯФС [AI SERVICE] SOLUTION: Get API key from https://makersuite.google.com/app/apikey');
            } else if (error.message.includes('QUOTA_EXCEEDED')) {
                console.error('ЁЯУИ [AI SERVICE] ISSUE: API quota exceeded');
                console.error('ЁЯУИ [AI SERVICE] SOLUTION: Wait or upgrade your API plan');
            } else if (error.message.includes('Failed to fetch')) {
                console.error('ЁЯМР [AI SERVICE] ISSUE: Network connection problem');
                console.error('ЁЯМР [AI SERVICE] SOLUTION: Check internet connection');
            }
            
            console.error('ЁЯУН [AI SERVICE] Full error stack:', error.stack);
            
            // Fallback response
            const fallbackMessage = this.detectLanguage(userMessage) === 'hindi' ?
                'рдорд╛рдл рдХрд░реЗрдВ, рдореИрдВ рдЕрднреА рдЖрдкрдХреА рдорджрдж рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ред рдХреГрдкрдпрд╛ рдмрд╛рдж рдореЗрдВ рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВред ЁЯдЦ' :
                'Sorry, I cannot help you right now. Please try again later. ЁЯдЦ';
                
            const errorResponse = {
                success: false,
                response: fallbackMessage,
                error: error.message,
                timestamp: new Date()
            };
            
            console.log('ЁЯЪС [AI SERVICE] Returning fallback response');
            console.log('тЭМ [AI SERVICE] ================== ERROR HANDLED ==================\n');
            
            return errorResponse;
        }
    }

    /**
     * Build conversation context for AI
     */
    buildConversationContext(history, currentMessage, systemPrompt, language) {
        let context = systemPrompt + '\n\n';
        
        // Add recent conversation history (last 5 messages)
        const recentHistory = history.slice(-5);
        
        recentHistory.forEach(msg => {
            context += `${msg.sender}: ${msg.message}\n`;
        });
        
        context += `User: ${currentMessage}\nHealthyAI:`;
        
        return context;
    }

    /**
     * Add safety disclaimer for serious symptoms
     */
    addSafetyDisclaimer(response, language) {
        // Keywords that trigger safety warnings
        const emergencyKeywords = {
            english: ['chest pain', 'can\'t breathe', 'severe', 'emergency', 'heart attack', 'stroke'],
            hindi: ['рд╕реАрдиреЗ рдореЗрдВ рджрд░реНрдж', 'рд╕рд╛рдВрд╕ рдирд╣реАрдВ', 'рдЧрдВрднреАрд░', 'рдЖрдкрд╛рддрдХрд╛рд▓', 'рджрд┐рд▓ рдХрд╛ рджреМрд░рд╛']
        };
        
        const keywords = emergencyKeywords[language] || emergencyKeywords.english;
        const hasEmergencyKeyword = keywords.some(keyword => 
            response.toLowerCase().includes(keyword.toLowerCase())
        );
        
        if (hasEmergencyKeyword) {
            const disclaimer = language === 'hindi' ?
                '\n\nтЪая╕П рдорд╣рддреНрд╡рдкреВрд░реНрдг: рдЧрдВрднреАрд░ рд▓рдХреНрд╖рдгреЛрдВ рдХреЗ рд▓рд┐рдП рддреБрд░рдВрдд рдбреЙрдХреНрдЯрд░ рд╕реЗ рдорд┐рд▓реЗрдВ рдпрд╛ рдЖрдкрд╛рддрдХрд╛рд▓реАрди рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рдХреЙрд▓ рдХрд░реЗрдВред' :
                '\n\nтЪая╕П Important: For serious symptoms, please see a doctor immediately or call emergency services.';
            
            return response + disclaimer;
        }
        
        return response;
    }

    /**
     * Format response for better visual presentation
     */
    formatResponse(response, language) {
        let formatted = response;
        
        // Highlight medicine names (common patterns)
        const medicinePatterns = [
            /\b([A-Z][a-z]+(?:ol|ine|cin|mic|ide|ate|ium))\s*(\d+\s*mg)/gi,
            /\b(Paracetamol|Ibuprofen|Aspirin|Amoxicillin|Azithromycin|Metformin|Omeprazole)\b/gi,
        ];
        
        medicinePatterns.forEach(pattern => {
            formatted = formatted.replace(pattern, '<span class="medicine-name">$&</span>');
        });
        
        // Highlight dosage information
        const dosagePatterns = [
            /(\d+\s*mg|\d+\s*ml|\d+\s*tablets?|\d+\s*times?\s*daily?|every\s*\d+\s*hours?)/gi,
            /(once daily|twice daily|three times daily|before meals|after meals)/gi
        ];
        
        dosagePatterns.forEach(pattern => {
            formatted = formatted.replace(pattern, '<span class="dosage-info">$&</span>');
        });
        
        // Highlight important warnings (but keep them subtle)
        const warningPatterns = [
            /(consult.*doctor|see.*doctor|emergency|urgent|immediately)/gi
        ];
        
        warningPatterns.forEach(pattern => {
            formatted = formatted.replace(pattern, '<span class="highlight">$&</span>');
        });
        
        return formatted;
    }

    /**
     * Generate medicine information
     */
    async getMedicineInfo(medicineName, userInfo = null) {
        try {
            const language = userInfo?.preferredLanguage || 'english';
            
            const prompt = language === 'hindi' ?
                `${medicineName} рджрд╡рд╛ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рджреЗрдВред рдЗрд╕рдХреЗ рдЙрдкрдпреЛрдЧ, рдЦреБрд░рд╛рдХ, рд╕рд╛рдЗрдб рдЗрдлреЗрдХреНрдЯреНрд╕ рдФрд░ рд╕рд╛рд╡рдзрд╛рдирд┐рдпреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрддрд╛рдПрдВред рд╕рд░рд▓ рднрд╛рд╖рд╛ рдореЗрдВ рд╕рдордЭрд╛рдПрдВред` :
                `Provide information about ${medicineName} medicine. Include its uses, dosage, side effects, and precautions. Explain in simple terms.`;
            
            const result = await this.model.generateContent(prompt);
            const response = await result.response;
            
            const disclaimer = language === 'hindi' ?
                '\n\nЁЯТК рд╕рд▓рд╛рд╣: рдХреЛрдИ рднреА рджрд╡рд╛ рд▓реЗрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рд╣рдореЗрд╢рд╛ рдбреЙрдХреНрдЯрд░ рд╕реЗ рд╕рд▓рд╛рд╣ рд▓реЗрдВред' :
                '\n\nЁЯТК Advice: Always consult a doctor before taking any medication.';
            
            return {
                success: true,
                response: response.text() + disclaimer,
                language: language
            };
            
        } catch (error) {
            console.error('тЭМ Medicine Info Error:', error);
            return {
                success: false,
                response: 'Sorry, I could not get medicine information right now.',
                error: error.message
            };
        }
    }

    /**
     * Health tips based on user profile
     */
    async getPersonalizedHealthTips(userInfo) {
        try {
            const language = userInfo?.preferredLanguage || 'english';
            
            const prompt = language === 'hindi' ?
                `рдЗрд╕ рд╡реНрдпрдХреНрддрд┐ рдХреЗ рд▓рд┐рдП рд╡реНрдпрдХреНрддрд┐рдЧрдд рд╕реНрд╡рд╛рд╕реНрдереНрдп рд╕реБрдЭрд╛рд╡ рджреЗрдВ: ${this.formatUserContext(userInfo, language)}ред 3 рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ рд╕реБрдЭрд╛рд╡ рджреЗрдВред` :
                `Provide personalized health tips for this person: ${this.formatUserContext(userInfo, language)}. Give 3 practical suggestions.`;
            
            const result = await this.model.generateContent(prompt);
            const response = await result.response;
            
            return {
                success: true,
                response: response.text(),
                language: language,
                type: 'health_tips'
            };
            
        } catch (error) {
            console.error('тЭМ Health Tips Error:', error);
            return {
                success: false,
                response: 'Unable to generate health tips right now.',
                error: error.message
            };
        }
    }

    /**
     * Analyze images with text using Gemini Vision API
     */
    async analyzeImagesWithText(textPrompt, imageData, language) {
        console.log('ЁЯЦ╝я╕П [AI SERVICE] Starting image analysis with Vision API...');
        
        try {
            // Get the vision model
            const visionModel = this.genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            
            // Create enhanced prompt for medical image analysis
            const imageAnalysisPrompt = this.createImageAnalysisPrompt(textPrompt, language);
            console.log('ЁЯУЭ [AI SERVICE] Image analysis prompt created');
            
            // Prepare image parts for Vision API
            const imageParts = imageData.map(img => ({
                inlineData: {
                    data: img.base64,
                    mimeType: img.mimeType
                }
            }));
            
            console.log('ЁЯУО [AI SERVICE] Processing', imageParts.length, 'images with Vision API...');
            
            // Send to Gemini Vision API
            const result = await visionModel.generateContent([
                imageAnalysisPrompt,
                ...imageParts
            ]);
            
            console.log('тЬЕ [AI SERVICE] Image analysis completed successfully');
            return result;
            
        } catch (error) {
            console.error('тЭМ [AI SERVICE] Image analysis error:', error);
            throw error;
        }
    }
    
    /**
     * Create enhanced prompt for medical image analysis
     */
    createImageAnalysisPrompt(originalPrompt, language) {
        const medicalImagePrompt = language === 'hindi' ? `
            рдЖрдк рдПрдХ рдЪрд┐рдХрд┐рддреНрд╕рд╛ рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ рд╣реИрдВред рдЗрд╕ рдЪрд┐рдХрд┐рддреНрд╕рд╛ рдЪрд┐рддреНрд░ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░реЗрдВ:
            
            рдирд┐рд░реНрджреЗрд╢:
            - рдмрд╣реБрдд рд╕рдВрдХреНрд╖рд┐рдкреНрдд рдФрд░ рд╕реНрдкрд╖реНрдЯ рд░рд╣реЗрдВ (3-4 рд╡рд╛рдХреНрдп рдореИрдХреНрд╕)
            - рдпрджрд┐ рдкрд░реНрдЪрд╛ рд╣реИ: рджрд╡рд╛ рдФрд░ рдЦреБрд░рд╛рдХ рдмрддрд╛рдПрдВ
            - рдпрджрд┐ рд░рд┐рдкреЛрд░реНрдЯ рд╣реИ: рдореБрдЦреНрдп рдмрд┐рдВрджреБ рдмрддрд╛рдПрдВ
            - рд╕рд░рд▓ рднрд╛рд╖рд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ
            
            рдореВрд▓ рдкреНрд░рд╕рдВрдЧ: ${originalPrompt}
            
            рд╕рдВрдХреНрд╖рд┐рдкреНрдд рд╡рд┐рд╢реНрд▓реЗрд╖рдг рджреЗрдВред
        ` : `
            You are a medical expert. Analyze this medical image CONCISELY:
            
            RULES:
            - Keep response VERY SHORT (3-4 sentences max)
            - If prescription: mention medicine name and dosage only
            - If medical report: state key findings only
            - Use simple language, no complex medical terms
            - Be helpful but brief
            
            Original context: ${originalPrompt}
            
            Provide a SHORT, clear analysis.
        `;
        
        return medicalImagePrompt;
    }

    /**
     * Check if Gemini API is working
     */
    async testConnection() {
        try {
            const result = await this.model.generateContent('Hello! Are you working?');
            const response = await result.response;
            
            return {
                success: true,
                message: 'Gemini AI is connected successfully! ЁЯдЦ',
                response: response.text()
            };
        } catch (error) {
            return {
                success: false,
                message: 'Gemini AI connection failed',
                error: error.message
            };
        }
    }
}

module.exports = new HealthAIService();
